# {{name}} by https://certbot.eff.org/

upstream {{name}}_prod {
	server localhost:{{port}} fail_timeout=0;
}

server {
	if ($scheme != "https") {
  	return 301 https://$host$request_uri;
	}

	listen 443 ssl http2;
	ssl_certificate /etc/letsencrypt/live/{{name}}/fullchain.pem;
	ssl_certificate_key /etc/letsencrypt/live/{{name}}/privkey.pem;
	include /etc/letsencrypt/options-ssl-nginx.conf;

	client_max_body_size 4G;
	keepalive_timeout 10;
	proxy_buffers 16 64k;
	proxy_buffer_size 128k;
	server_name {{name}};
	charset utf-8;
	root {{root}}/public;
	index index.html;

	access_log /var/log/nginx/{{name}}.access.log;
	error_log /var/log/nginx/{{name}}.error.log;

	location / {
		try_files $uri $uri/ /index.html;
	}

	location /upload/ {
		alias "{{root}}/tmp/upload/";
	}

	# Feed
	location ~* \.(?:rss|atom)$ {
	  expires 6h;
	  add_header Cache-Control "public";
	}

	# Media: images, icons, video, audio, HTC
	location ~* \.(?:jpg|jpeg|gif|png|ico|cur|gz|svg|svgz|mp4|ogg|ogv|webm|htc)$ {
	  expires 1M;
	  access_log off;
	  add_header Cache-Control "public";
	}

	# CSS and Javascript
	location ~* \.(?:css|js)$ {
	  expires 1y;
	  access_log off;
	  add_header Cache-Control "public";
	}

	location /api/{{version}}/ {
		proxy_set_header X-Forwarded-Proto https;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header Host $http_host;
		proxy_set_header X-Real-IP $remote_addr;

		rewrite ^/api/{{version}}/?(.*) /$1 break;
		proxy_pass http://{{name}}_prod;
		proxy_redirect off;

		# limit_req zone=one;
	}
}
